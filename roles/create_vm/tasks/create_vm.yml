---
  - include_vars: main.yml
  - include_vars: esxi_drs.yml
  - include_vars: vm_details.yml
  - include_vars: vm_hardware.yml
  - include_vars: vmvault.yml
  # Create Vm from the below template
  - name: Create a VM from a template
    vmware_guest:
      hostname: '{{ vcenter_hostname }}'
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      name: '{{ item.vm_name }}'
      state: poweredon
      template: '{{ rhel_template }}'
      datacenter: '{{ datacenter_name }}'
      cluster: '{{ cluster }}'
      folder: "/{{ datacenter_name }}/vm/"
      hardware:
        memory_mb: '{{ ram }}'
        num_cpus: '{{ cpu }}'
        scsi: lsilogic
      disk:
      - size_gb: "{{ disk2_size }}"
        type: "{{ disk2_type }}"
        datastore: "{{ datastore_name }}"
        state: "{{ disk2_state }}"
      - size_gb: "{{ disk2_size }}"
        type: "{{ disk2_type }}"
        datastore: "{{ datastore_name }}"
        state: "{{ disk2_state }}"
      customization:
        hostname: '{{ item.hostname }}'
        autologon: yes
        password: '{{ vm_password }}'
        dns_servers:
        - 10.129.16.17
        - 10.129.16.18
      networks:
      - name: '{{ item.network_name }}'
        ip: '{{ item.addr }}'
        type: static
        netmask: '{{ netmask }}'
        gateway: '{{ gateway }}'
        domain: '{{ domain }}'
        connected: true
      - vlan: '{{ vlan }}'
        device_type: '{{ devicetype }}'
        dvswitch_name: '{{ dvswitch }}'
        wait_for_ip_address: yes
    delegate_to: localhost
    register: deploy
    with_items:
       - { vm_name: "{{ vm_name }}", hostname: "{{ vm_hostname }}", addr: "{{ vm_ip }}", network_name: "{{ vm_network_name }}"  }
       - { vm_name: "DRS-TEST03-OKD", hostname: "DRS-TEST03-OKD", addr: "10.60.10.32", network_name: "{{ vm_network_name }}"  }
       - { vm_name: "DRS-TEST04-OKD", hostname: "DRS-TEST04-OKD", addr: "10.60.10.33", network_name: "{{ vm_network_name }}"  }

   


